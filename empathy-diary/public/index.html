<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI ê³µê° ë‹¤ì´ì–´ë¦¬</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #fef9f3 0%, #fdf2e9 50%, #fce8d9 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      width: 100%;
    }

    .diary-card {
      background: white;
      border-radius: 24px;
      box-shadow: 0 10px 40px rgba(139, 90, 43, 0.1);
      padding: 40px 32px;
      position: relative;
      overflow: hidden;
    }

    .diary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, #f8b595, #f67280, #c06c84);
    }

    .header {
      text-align: center;
      margin-bottom: 32px;
    }

    .moon-icon {
      font-size: 3rem;
      margin-bottom: 12px;
      display: block;
    }

    .header h1 {
      font-size: 1.6rem;
      color: #5d4e37;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .header p {
      color: #9a8478;
      font-size: 0.95rem;
    }

    .date-display {
      text-align: center;
      margin-bottom: 24px;
      padding: 12px;
      background: #fef9f3;
      border-radius: 12px;
      color: #8b7355;
      font-size: 0.9rem;
    }

    .entry-section {
      margin-bottom: 24px;
    }

    .entry-label {
      display: block;
      font-size: 0.9rem;
      color: #7a6b5a;
      margin-bottom: 10px;
      font-weight: 500;
    }

    .entry-input {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid #f0e6dc;
      border-radius: 16px;
      font-size: 1rem;
      color: #5d4e37;
      background: #fefcfa;
      transition: all 0.3s ease;
      outline: none;
    }

    .entry-input:focus {
      border-color: #f8b595;
      box-shadow: 0 0 0 4px rgba(248, 181, 149, 0.15);
    }

    .entry-input::placeholder {
      color: #c4b5a5;
    }

    .submit-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #f8b595 0%, #f67280 100%);
      border: none;
      border-radius: 16px;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(246, 114, 128, 0.3);
    }

    .submit-btn:disabled {
      background: #d4c5b5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .loading-section {
      text-align: center;
      padding: 40px 20px;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid #f0e6dc;
      border-top-color: #f67280;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: #9a8478;
      font-size: 0.95rem;
    }

    .response-section {
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .emotion-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #fef9f3 0%, #fdf2e9 100%);
      padding: 12px 20px;
      border-radius: 50px;
      margin-bottom: 24px;
    }

    .emotion-emoji {
      font-size: 1.8rem;
    }

    .emotion-info {
      text-align: left;
    }

    .emotion-name {
      font-size: 1rem;
      color: #5d4e37;
      font-weight: 600;
    }

    .emotion-intensity {
      font-size: 0.8rem;
      color: #9a8478;
    }

    .intensity-bar {
      display: flex;
      gap: 3px;
      margin-top: 4px;
    }

    .intensity-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #e8ddd0;
    }

    .intensity-dot.active {
      background: linear-gradient(135deg, #f8b595 0%, #f67280 100%);
    }

    .message-box {
      background: #fef9f3;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      border-left: 4px solid #f8b595;
    }

    .message-label {
      font-size: 0.75rem;
      color: #b39e8d;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .message-content {
      color: #5d4e37;
      font-size: 1rem;
      line-height: 1.7;
    }

    .advice-box {
      background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #81c784;
    }

    .affirmation-box {
      background: linear-gradient(135deg, #fff3e0 0%, #fff8e1 100%);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      border: 2px dashed #ffcc80;
    }

    .affirmation-content {
      color: #5d4e37;
      font-size: 1.1rem;
      font-weight: 500;
      font-style: italic;
    }

    .new-entry-btn {
      width: 100%;
      padding: 14px;
      background: white;
      border: 2px solid #f0e6dc;
      border-radius: 12px;
      color: #8b7355;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
    }

    .new-entry-btn:hover {
      background: #fef9f3;
      border-color: #f8b595;
      color: #5d4e37;
    }

    .history-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #f0e6dc;
    }

    .history-title {
      font-size: 0.9rem;
      color: #9a8478;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .history-item {
      background: #fef9f3;
      padding: 12px 16px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .history-item:hover {
      background: #fdf2e9;
    }

    .history-emoji {
      font-size: 1.4rem;
    }

    .history-content {
      flex: 1;
      min-width: 0;
    }

    .history-entry {
      font-size: 0.85rem;
      color: #5d4e37;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-date {
      font-size: 0.75rem;
      color: #b39e8d;
    }

    .error-message {
      background: #fff5f5;
      border: 1px solid #feb2b2;
      border-radius: 12px;
      padding: 16px;
      color: #c53030;
      text-align: center;
      margin-bottom: 16px;
    }

    .footer {
      text-align: center;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #f0e6dc;
      color: #b39e8d;
      font-size: 0.8rem;
    }

    @media (max-width: 480px) {
      .diary-card {
        padding: 32px 24px;
      }

      .header h1 {
        font-size: 1.4rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="diary-card">
      <div class="header">
        <span class="moon-icon">ğŸŒ™</span>
        <h1>AI ê³µê° ë‹¤ì´ì–´ë¦¬</h1>
        <p>ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë• ë‚˜ìš”?</p>
      </div>

      <div class="date-display" id="dateDisplay"></div>

      <!-- ì…ë ¥ í™”ë©´ -->
      <div id="inputSection">
        <div class="entry-section">
          <label class="entry-label">ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼ì„ í•œ ì¤„ë¡œ ì ì–´ì£¼ì„¸ìš”</label>
          <input
            type="text"
            class="entry-input"
            id="entryInput"
            placeholder="ì˜ˆ: ì˜¤ëœë§Œì— ì¹œêµ¬ë¥¼ ë§Œë‚˜ì„œ í–‰ë³µí–ˆì–´ìš”"
            maxlength="200"
          >
        </div>
        <button class="submit-btn" id="submitBtn">
          <span>ë§ˆìŒ ë‚˜ëˆ„ê¸°</span>
          <span>ğŸ’</span>
        </button>
      </div>

      <!-- ë¡œë”© í™”ë©´ -->
      <div id="loadingSection" style="display: none;">
        <div class="loading-section">
          <div class="spinner"></div>
          <p class="loading-text">ë‹¹ì‹ ì˜ ë§ˆìŒì„ ì½ê³  ìˆì–´ìš”...</p>
        </div>
      </div>

      <!-- ê²°ê³¼ í™”ë©´ -->
      <div id="responseSection" style="display: none;" class="response-section">
        <div style="text-align: center;">
          <div class="emotion-badge">
            <span class="emotion-emoji" id="emotionEmoji">ğŸ’­</span>
            <div class="emotion-info">
              <div class="emotion-name" id="emotionName">ê°ì • ë¶„ì„ ì¤‘</div>
              <div class="intensity-bar" id="intensityBar"></div>
            </div>
          </div>
        </div>

        <div class="message-box">
          <div class="message-label">ê³µê° ë©”ì‹œì§€</div>
          <p class="message-content" id="empathyMessage"></p>
        </div>

        <div class="advice-box">
          <div class="message-label">ì˜¤ëŠ˜ì˜ ì¡°ì–¸</div>
          <p class="message-content" id="adviceMessage"></p>
        </div>

        <div class="affirmation-box">
          <p class="affirmation-content" id="affirmationMessage"></p>
        </div>

        <button class="new-entry-btn" id="newEntryBtn">ìƒˆë¡œìš´ ì¼ê¸° ì“°ê¸° âœï¸</button>
      </div>

      <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
      <div id="errorSection" style="display: none;">
        <div class="error-message" id="errorMessage"></div>
        <button class="new-entry-btn" id="retryBtn">ë‹¤ì‹œ ì‹œë„í•˜ê¸°</button>
      </div>

      <!-- íˆìŠ¤í† ë¦¬ -->
      <div class="history-section" id="historySection" style="display: none;">
        <div class="history-title">
          <span>ğŸ“š</span>
          <span>ìµœê·¼ ê¸°ë¡</span>
        </div>
        <div class="history-list" id="historyList"></div>
      </div>

      <div class="footer">
        ë‹¹ì‹ ì˜ í•˜ë£¨ë¥¼ ì‘ì›í•©ë‹ˆë‹¤ ğŸ’•
      </div>
    </div>
  </div>

  <script>
    // DOM ìš”ì†Œ
    const dateDisplay = document.getElementById('dateDisplay');
    const inputSection = document.getElementById('inputSection');
    const loadingSection = document.getElementById('loadingSection');
    const responseSection = document.getElementById('responseSection');
    const errorSection = document.getElementById('errorSection');
    const historySection = document.getElementById('historySection');
    const entryInput = document.getElementById('entryInput');
    const submitBtn = document.getElementById('submitBtn');
    const newEntryBtn = document.getElementById('newEntryBtn');
    const retryBtn = document.getElementById('retryBtn');

    // ê²°ê³¼ í‘œì‹œ ìš”ì†Œ
    const emotionEmoji = document.getElementById('emotionEmoji');
    const emotionName = document.getElementById('emotionName');
    const intensityBar = document.getElementById('intensityBar');
    const empathyMessage = document.getElementById('empathyMessage');
    const adviceMessage = document.getElementById('adviceMessage');
    const affirmationMessage = document.getElementById('affirmationMessage');
    const errorMessage = document.getElementById('errorMessage');
    const historyList = document.getElementById('historyList');

    // íˆìŠ¤í† ë¦¬ ì €ì¥ì†Œ
    let diaryHistory = JSON.parse(localStorage.getItem('diaryHistory') || '[]');

    // ì´ˆê¸°í™”
    function init() {
      updateDateDisplay();
      renderHistory();

      submitBtn.addEventListener('click', submitEntry);
      entryInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') submitEntry();
      });
      newEntryBtn.addEventListener('click', resetToInput);
      retryBtn.addEventListener('click', resetToInput);
    }

    // ë‚ ì§œ í‘œì‹œ
    function updateDateDisplay() {
      const now = new Date();
      const options = {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      };
      dateDisplay.textContent = now.toLocaleDateString('ko-KR', options);
    }

    // ì„¹ì…˜ ì „í™˜
    function showSection(section) {
      inputSection.style.display = 'none';
      loadingSection.style.display = 'none';
      responseSection.style.display = 'none';
      errorSection.style.display = 'none';

      switch(section) {
        case 'input':
          inputSection.style.display = 'block';
          break;
        case 'loading':
          loadingSection.style.display = 'block';
          break;
        case 'response':
          responseSection.style.display = 'block';
          break;
        case 'error':
          errorSection.style.display = 'block';
          break;
      }
    }

    // ì¼ê¸° ì œì¶œ
    async function submitEntry() {
      const entry = entryInput.value.trim();

      if (!entry) {
        entryInput.focus();
        entryInput.style.borderColor = '#f67280';
        setTimeout(() => {
          entryInput.style.borderColor = '#f0e6dc';
        }, 2000);
        return;
      }

      showSection('loading');
      submitBtn.disabled = true;

      try {
        const response = await fetch('/api/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ entry })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }

        if (data.success && data.analysis) {
          displayResponse(data.analysis);
          saveToHistory(entry, data.analysis);
          showSection('response');
        } else {
          throw new Error('ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }

      } catch (error) {
        console.error('Error:', error);
        errorMessage.textContent = error.message;
        showSection('error');
      } finally {
        submitBtn.disabled = false;
      }
    }

    // ê²°ê³¼ í‘œì‹œ
    function displayResponse(analysis) {
      emotionEmoji.textContent = analysis.emotionEmoji || 'ğŸ’­';
      emotionName.textContent = analysis.emotion || 'ì•Œ ìˆ˜ ì—†ìŒ';

      // ê°•ë„ ë°” ë Œë”ë§
      const intensity = Math.min(10, Math.max(1, parseInt(analysis.intensity) || 5));
      intensityBar.innerHTML = '';
      for (let i = 1; i <= 10; i++) {
        const dot = document.createElement('div');
        dot.className = 'intensity-dot' + (i <= intensity ? ' active' : '');
        intensityBar.appendChild(dot);
      }

      empathyMessage.textContent = analysis.empathyMessage || '';
      adviceMessage.textContent = analysis.advice || '';
      affirmationMessage.textContent = `"${analysis.affirmation || 'ë‚˜ëŠ” ì¶©ë¶„íˆ ì˜í•˜ê³  ìˆì–´ìš”.'}"`;
    }

    // íˆìŠ¤í† ë¦¬ ì €ì¥
    function saveToHistory(entry, analysis) {
      const record = {
        id: Date.now(),
        date: new Date().toISOString(),
        entry: entry,
        emotion: analysis.emotion,
        emoji: analysis.emotionEmoji
      };

      diaryHistory.unshift(record);

      // ìµœëŒ€ 30ê°œê¹Œì§€ë§Œ ì €ì¥
      if (diaryHistory.length > 30) {
        diaryHistory = diaryHistory.slice(0, 30);
      }

      localStorage.setItem('diaryHistory', JSON.stringify(diaryHistory));
      renderHistory();
    }

    // íˆìŠ¤í† ë¦¬ ë Œë”ë§
    function renderHistory() {
      if (diaryHistory.length === 0) {
        historySection.style.display = 'none';
        return;
      }

      historySection.style.display = 'block';
      historyList.innerHTML = diaryHistory.slice(0, 5).map(record => {
        const date = new Date(record.date);
        const dateStr = date.toLocaleDateString('ko-KR', {
          month: 'short',
          day: 'numeric'
        });

        return `
          <div class="history-item" title="${escapeHtml(record.entry)}">
            <span class="history-emoji">${escapeHtml(record.emoji)}</span>
            <div class="history-content">
              <div class="history-entry">${escapeHtml(record.entry)}</div>
              <div class="history-date">${dateStr} Â· ${escapeHtml(record.emotion)}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // XSS ë°©ì§€
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    // ì…ë ¥ í™”ë©´ìœ¼ë¡œ ë¦¬ì…‹
    function resetToInput() {
      entryInput.value = '';
      showSection('input');
      entryInput.focus();
    }

    // ì•± ì‹œì‘
    init();
  </script>
</body>
</html>
